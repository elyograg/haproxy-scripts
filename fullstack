#!/bin/bash

SCRIPT_DIR="$(cd "$(dirname "$0")" || exit ; pwd -P)"
# shellcheck source=/dev/null
source "${SCRIPT_DIR}/functions.sh"

info "Starting fullstack script"
info "CI branch: ${CI_COMMIT_REF_NAME}"
if [ -z "${CI_COMMIT_REF_NAME}" ]; then
  echo "NOT doing CI."
  if [[ "$(hostname -f)" == *"elyograg"* ]]; then
    if [[ "$(hostname)" != *"smeagol"* ]]; then
      warn "Syncing from smeagol.elyograg.org"
      ./sync_from_smeagol 2>&1
    else
      info "This host IS smeagol.  Skipping sync."
    fi
  fi
  sudo -E git pull --rebase 2>&1
fi

./new-quic git-quictls 2>&1
./new-haproxy git-haproxy-master 2>&1
